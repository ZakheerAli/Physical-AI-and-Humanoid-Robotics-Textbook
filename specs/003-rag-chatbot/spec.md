# Feature Specification: RAG Chatbot Integration

**ID**: `003-rag-chatbot`
**Status**: Refined
**Priority**: High
**Created**: 2025-12-18
**Updated**: 2025-12-18

---

## 1. Context

**Why are we building this?**

To enhance the user experience of the *Physical AI and Humanoid Robotics* textbook by providing an interactive way for users to get answers to their questions directly from the book's content. This feature addresses the need for on-demand, contextual clarification, transforming the static book into a dynamic learning tool.

---

## 2. Requirements

### 2.1. Functional Requirements

*   **FR1: Chatbot Interface**
    *   [ ] The chatbot UI MUST be embeddable within the Docusaurus frontend.
    *   [ ] The interface MUST provide a clear input area for users to type questions.
    *   [ ] The interface MUST display the conversation history.

*   **FR2: Retrieval Modes**
    *   [ ] **Full-Book Retrieval:** The chatbot MUST be able to answer questions based on the entire content of the book.
    *   [ ] **Selected-Text Retrieval:** The chatbot MUST be able to answer questions based *only* on a specific snippet of text highlighted by the user.

*   **FR3: Response Generation**
    *   [ ] Responses MUST be generated by a language model using retrieved context.
    *   [ ] Responses SHOULD be accurate and relevant to the user's query and the provided context.

### 2.2. Technical Requirements

*   **TR1: Backend Service**
    *   [ ] The backend MUST be a FastAPI application.
    *   [ ] It MUST expose endpoints for the chatbot to communicate with.
    *   [ ] It MUST handle the logic for both retrieval modes.

*   **TR2: Data Storage**
    *   [ ] **Vector Store:** Qdrant Cloud MUST be used to store text embeddings and perform semantic search.
    *   [ ] **Relational DB:** Neon Serverless PostgreSQL MUST be used for storing conversation history, user feedback, and other metadata.

*   **TR3: Content Ingestion**
    *   [ ] A RAG pipeline MUST be created to process the book's MDX files.
    *   [ ] The pipeline MUST chunk the text, generate embeddings (using a `sentence-transformers` model like `all-MiniLM-L6-v2`), and store them in Qdrant.

*   **TR4: Conversational Logic**
    *   [ ] The **OpenAI Agents SDK** MUST be used to manage the conversational flow.
    *   [ ] The OpenAI client MUST be configured to use **Google Gemini (Free Tier)** via the OpenAI-compatible endpoint (`https://generativelanguage.googleapis.com/v1beta/openai/`).
    *   [ ] Native OpenAI models MUST NOT be used; Gemini is the generation engine.

### 2.3. Non-Functional Requirements

*   **NFR1: Preservation of Phase 1:** Phase 1 artifacts (specs, code, deployment) MUST remain untouched.
*   **NFR2: Performance:** The chatbot SHOULD respond to user queries within a reasonable timeframe (e.g., < 5 seconds for a typical query).

---

## 3. Prompt Strategy (for the end-user chatbot)

The chatbot should be primed with a system prompt that encourages it to act as a helpful teaching assistant for the *Physical AI and Humanoid Robotics* textbook.

**Example System Prompt:**
"You are a helpful assistant for the 'Physical AI and Humanoid Robotics' textbook. Your goal is to answer questions accurately based on the provided text. If the answer is not in the text, say so. Be concise and clear in your explanations."

---

## 4. Acceptance Criteria

**Definition of Done (DoD):**

*   [ ] **Criterion 1: Backend Ready:** The FastAPI application is containerized and has endpoints for both retrieval modes.
*   [ ] **Criterion 2: Databases Ready:** The Qdrant Cloud and Neon PostgreSQL instances are provisioned, and the application is connected to them.
*   [ ] **Criterion 3: Ingestion Complete:** The content of the book has been successfully ingested into Qdrant. A script exists to repeat this process.
*   [ ] **Criterion 4: UI Embedded:** A new React component for the chatbot is created and appears on the Docusaurus pages (e.g., as a floating button or in the sidebar).
*   [ ] **Criterion 5: Full-Book Retrieval Works:** Users can ask a question against the full book, and the chatbot provides an accurate answer with sources.
*   [ ] **Criterion 6: Selected-Text Retrieval Works:** Users can select text on a page, trigger the chatbot, and receive an answer based only on that selection.
*   [ ] **Criterion 7: No Regressions:** The Phase 1 static site builds and deploys successfully without any new errors.